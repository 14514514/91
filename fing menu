local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local SlapEvent = ReplicatedStorage:WaitForChild("ITS")
_G.go = false
_G.playerSlapStates = {}
_G.uiExpanded = true

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 300, 0, 400)
Frame.Position = UDim2.new(1, -310, 0.5, -200)
Frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Text = "拍飞控制器"
Title.Size = UDim2.new(1, -40, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Parent = Frame

local ToggleExpandButton = Instance.new("TextButton")
ToggleExpandButton.Text = "-"
ToggleExpandButton.Size = UDim2.new(0, 30, 0, 30)
ToggleExpandButton.Position = UDim2.new(1, -30, 0, 0)
ToggleExpandButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
ToggleExpandButton.TextColor3 = Color3.new(1, 1, 1)
ToggleExpandButton.Font = Enum.Font.SourceSansBold
ToggleExpandButton.TextSize = 20
ToggleExpandButton.Parent = Frame

local ToggleButton = Instance.new("TextButton")
ToggleButton.Text = "开启全体拍飞"
ToggleButton.Size = UDim2.new(0.9, 0, 0, 30)
ToggleButton.Position = UDim2.new(0.05, 0, 0.1, 0)
ToggleButton.Parent = Frame

local NameInput = Instance.new("TextBox")
NameInput.PlaceholderText = "输入玩家名(任意分隔符)"
NameInput.Size = UDim2.new(0.9, 0, 0, 30)
NameInput.Position = UDim2.new(0.05, 0, 0.2, 0)
NameInput.Parent = Frame

local SlapSingleButton = Instance.new("TextButton")
SlapSingleButton.Text = "拍飞指定玩家"
SlapSingleButton.Size = UDim2.new(0.9, 0, 0, 30)
SlapSingleButton.Position = UDim2.new(0.05, 0, 0.3, 0)
SlapSingleButton.Parent = Frame

local PlayerListFrame = Instance.new("Frame")
PlayerListFrame.Size = UDim2.new(0.9, 0, 0.55, 0)
PlayerListFrame.Position = UDim2.new(0.05, 0, 0.4, 0)
PlayerListFrame.BackgroundTransparency = 1
PlayerListFrame.Visible = true
PlayerListFrame.Parent = Frame

local PlayerListLayout = Instance.new("UIListLayout")
PlayerListLayout.Padding = UDim.new(0, 5)
PlayerListLayout.Parent = PlayerListFrame

local PlayerListTitle = Instance.new("TextLabel")
PlayerListTitle.Text = "玩家控制:"
PlayerListTitle.Size = UDim2.new(1, 0, 0, 20)
PlayerListTitle.TextColor3 = Color3.new(1, 1, 1)
PlayerListTitle.BackgroundTransparency = 1
PlayerListTitle.Parent = PlayerListFrame

local lastActivationTime = 0

local function EnsureActivation()
    if os.clock() - lastActivationTime > 5 then
        if LocalPlayer.Character then
            SlapEvent:FireServer("slash", LocalPlayer.Character, Vector3.new(0,0,0))
        end
        lastActivationTime = os.clock()
    end
end

local function SlapPlayer(player)
    EnsureActivation()
    
    if player and player.Character and player.Character:FindFirstChild("Humanoid") then
        local charPos = LocalPlayer.Character.HumanoidRootPart.Position
        local targetPos = player.Character.HumanoidRootPart.Position
        
        local direction = (targetPos - charPos).Unit
        local force = direction * 30 + Vector3.new(0, 10, 0)
        
        SlapEvent:FireServer("slash", player.Character, force)
    end
end

local function SlapAll()
    EnsureActivation()
    
    while _G.go do
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                SlapPlayer(player)
            end
        end
        task.wait(0.1)
    end
end

local function SlapSpecific(player)
    while _G.playerSlapStates[player] do
        if player and player.Character and player.Character:FindFirstChild("Humanoid") then
            SlapPlayer(player)
        end
        task.wait(0.3)
    end
end

local function CreatePlayerControl(player)
    local playerFrame = Instance.new("Frame")
    playerFrame.Size = UDim2.new(1, 0, 0, 30)
    playerFrame.BackgroundTransparency = 1
    playerFrame.Parent = PlayerListFrame
    
    local playerName = Instance.new("TextLabel")
    playerName.Text = player.Name
    playerName.Size = UDim2.new(0.5, 0, 1, 0)
    playerName.TextColor3 = Color3.new(1, 1, 1)
    playerName.BackgroundTransparency = 1
    playerName.Parent = playerFrame
    
    local slapToggle = Instance.new("TextButton")
    slapToggle.Text = "开启指定玩家循环拍飞"
    slapToggle.Size = UDim2.new(0.5, 0, 1, 0)
    slapToggle.Position = UDim2.new(0.5, 0, 0, 0)
    slapToggle.TextColor3 = Color3.new(1, 1, 1)
    slapToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    slapToggle.Parent = playerFrame
    
    slapToggle.MouseButton1Click:Connect(function()
        _G.playerSlapStates[player] = not _G.playerSlapStates[player]
        if _G.playerSlapStates[player] then
            slapToggle.Text = "关闭指定玩家循环拍飞"
            slapToggle.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
            coroutine.wrap(SslapToggle.MouseButton1Click:Connect(function()
    _G.playerSlapStates[player] = not _G.playerSlapStates[player]
    if _G.playerSlapStates[player] then
        slapToggle.Text = "关闭指定玩家循环拍飞"
        slapToggle.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
        coroutine.wrap(SlapSpecific)(player)
    else
        slapToggle.Text = "开启指定玩家循环拍飞"
        slapToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    end
end)

return playerFrame
end

local function UpdatePlayerList()
    for _, child in ipairs(PlayerListFrame:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            CreatePlayerControl(player)
        end
    end
end

local function ToggleUI()
    _G.uiExpanded = not _G.uiExpanded
    
    if _G.uiExpanded then
        Frame.Size = UDim2.new(0, 300, 0, 400)
        ToggleExpandButton.Text = "-"
        ToggleButton.Visible = true
        NameInput.Visible = true
        SlapSingleButton.Visible = true
        PlayerListFrame.Visible = true
    else
        Frame.Size = UDim2.new(0, 150, 0, 30)
        ToggleExpandButton.Text = "+"
        ToggleButton.Visible = false
        NameInput.Visible = false
        SlapSingleButton.Visible = false
        PlayerListFrame.Visible = false
    end
end

local function FindPlayersByNamePattern(input)
    local targets = {}
    if #input == 0 then return targets end
    
    for _, player in ipairs(Players:GetPlayers()) do
        for word in string.gmatch(input, "[^%s,;|]+") do
            if string.find(player.Name:lower(), word:lower(), 1, true) then
                table.insert(targets, player)
                break
            end
        end
    end
    return targets
end

local function InitializeSlap()
    for i = 1, 3 do
        if LocalPlayer.Character then
            SlapEvent:FireServer("slash", LocalPlayer.Character, Vector3.new(0,0,0))
            lastActivationTime = os.clock()
            break
        end
        task.wait(0.5)
    end
end

Players.PlayerAdded:Connect(UpdatePlayerList)
Players.PlayerRemoving:Connect(UpdatePlayerList)

task.spawn(function()
    LocalPlayer.CharacterAdded:Wait()
    task.wait(1)
    InitializeSlap()
    UpdatePlayerList()
end)

InitializeSlap()
UpdatePlayerList()

ToggleExpandButton.MouseButton1Click:Connect(ToggleUI)

ToggleButton.MouseButton1Click:Connect(function()
    _G.go = not _G.go
    if _G.go then
        ToggleButton.Text = "关闭全体拍飞"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
        coroutine.wrap(SlapAll)()
    else
        ToggleButton.Text = "开启全体拍飞"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    end
end)

SlapSingleButton.MouseButton1Click:Connect(function()
    local targets = FindPlayersByNamePattern(NameInput.Text)
    for _, target in ipairs(targets) do
        SlapPlayer(target)
    end
end)
